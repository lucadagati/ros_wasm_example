@startuml Communication Sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60
skinparam ParticipantPadding 20

title Communication Sequence Diagram\nWASM-ROS Communication via ROS Bridge

participant "Publisher WASM\n(Environment 1)" as P #667eea
participant "JavaScript\n(Publisher)" as JS1 #9C27B0
participant "ROS Bridge\n(WebSocket)" as RB #4CAF50
participant "ROS2 Topic\nNetwork" as ROS #FFC107
participant "JavaScript\n(Subscriber)" as JS2 #9C27B0
participant "Subscriber WASM\n(Environment 2)" as S #f5576c

== Initialization ==
P -> P: Load WASM module
activate P
P -> JS1: Module ready
activate JS1
JS1 -> RB: WebSocket connect\nws://localhost:9090
activate RB
RB -> ROS: Register connection
activate ROS
deactivate ROS
RB --> JS1: Connection established
deactivate RB
JS1 --> P: WASM ready
deactivate JS1

S -> S: Load WASM module
activate S
S -> JS2: Module ready
activate JS2
JS2 -> RB: WebSocket connect\nws://localhost:9090
activate RB
RB -> ROS: Register connection
activate ROS
deactivate ROS
RB --> JS2: Connection established
deactivate RB
JS2 --> S: WASM ready
deactivate JS2

== Message Publishing Loop ==
loop Every second
    P -> P: generateMessage()\n(business logic in WASM)
    P --> JS1: return JSON message
    JS1 -> JS1: Create ROSLIB.Topic
    JS1 -> RB: publish(topic, message)\nvia WebSocket
    activate RB
    RB -> ROS: ROS2 publish\n/sensor/temperature
    activate ROS
    ROS -> ROS: Message queued
    ROS --> RB: Message published
    deactivate ROS
    RB --> JS1: Publish confirmed
    deactivate RB
    JS1 --> P: Update statistics
    deactivate JS1
    
    ROS -> RB: Message delivery\nvia ROS2 DDS
    activate RB
    RB -> JS2: WebSocket message\ncallback
    activate JS2
    JS2 -> S: processMessage(data)\n(business logic in WASM)
    activate S
    S -> S: Parse & process\nin WASM
    S --> JS2: return statistics
    deactivate S
    JS2 -> JS2: Update UI
    deactivate JS2
    deactivate RB
end

note over P, S
  **Current Implementation:**
  
  • Business logic: WASM
  • ROS communication: JavaScript + ROS Bridge
  • ROS Bridge: External ROS2 process
  
  **Target Architecture:**
  • All ROS code: Inside WASM
  • Direct WASM-to-WASM: ROS2 DDS
  • No external bridge needed
end note

@enduml

