@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60
skinparam ParticipantPadding 20

title Publisher WASM - Communication Sequence\nEnvironment 1: Temperature Sensor

participant "Browser Tab 1" as BROWSER #667eea
participant "PublisherNode\n(C++ WASM)" as WASM_NODE #4CAF50
participant "JavaScript\nGlue Code" as JS #9C27B0

participant "ROS Bridge\n(WebSocket)" as RB #FFC107
participant "ROS2 Topic\n/sensor/temperature" as ROS #f5576c

== Initialization ==
BROWSER -> WASM_NODE: Load publisher_module.wasm
activate WASM_NODE
WASM_NODE -> WASM_NODE: Initialize PublisherNode\n- message_count = 0\n- sensor_value = 0.0
WASM_NODE --> BROWSER: Module loaded
deactivate WASM_NODE

BROWSER -> JS: Initialize ROSLIB.Ros
activate JS
JS -> RB: WebSocket connect\nws://localhost:9090
activate RB
RB --> JS: Connection established
RB --> JS: WebSocket ready
JS -> JS: Create ROSLIB.Topic\n/sensor/temperature
JS --> BROWSER: ROS connected
deactivate JS
deactivate RB

== Message Publishing Loop ==
loop Every second
    BROWSER -> WASM_NODE: generateMessage()
    activate WASM_NODE
    WASM_NODE -> WASM_NODE: message_count++\nsensor_value = 20.0 + (count % 10)
    WASM_NODE -> WASM_NODE: Format JSON message\nid: X, sensor: temperature,\nvalue: Y, unit: celsius
    WASM_NODE --> JS: return JSON string
    deactivate WASM_NODE
    
    activate JS
    JS -> JS: Create ROSLIB.Message\nwith JSON data
    JS -> RB: publish(topic, message)\nvia WebSocket
    activate RB
    RB -> ROS: ROS2 publish\nstd_msgs/String
    activate ROS
    ROS -> ROS: Message queued\nin ROS2 topic
    ROS --> RB: Publish confirmed
    deactivate ROS
    RB --> JS: Publish success
    deactivate RB
    
    JS -> WASM_NODE: getMessageCount()
    activate WASM_NODE
    WASM_NODE --> JS: return count
    deactivate WASM_NODE
    
    JS -> WASM_NODE: getSensorValue()
    activate WASM_NODE
    WASM_NODE --> JS: return value
    deactivate WASM_NODE
    
    JS -> BROWSER: Update UI\n- Message count\n- Current value\n- Status
    deactivate JS
end

note over WASM_NODE
  **Inside Publisher WASM:**
  
  • PublisherNode class (C++)
  • generateMessage() - business logic
  • getMessageCount() - statistics
  • getSensorValue() - current reading
  • All compiled to WASM bytecode
  • Executed by WASM runtime
end note

note over JS, RB
  **Communication Layer:**
  
  • JavaScript: ROSLIB.js bridge
  • ROS Bridge: External ROS2 process
  • WebSocket: ws://localhost:9090
  • Topic: /sensor/temperature
end note

@enduml

