@startuml Subscriber Sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60
skinparam ParticipantPadding 20

title Subscriber WASM - Communication Sequence\nEnvironment 2: Actuator/Controller

package "Subscriber WASM Environment" {
    participant "Browser Tab 2" as BROWSER #f5576c
    participant "SubscriberNode\n(C++ WASM)" as WASM_NODE #4CAF50
    participant "JavaScript\nGlue Code" as JS #9C27B0
}

participant "ROS Bridge\n(WebSocket)" as RB #FFC107
participant "ROS2 Topic\n/sensor/temperature" as ROS #667eea

== Initialization ==
BROWSER -> WASM_NODE: Load subscriber_module.wasm
activate WASM_NODE
WASM_NODE -> WASM_NODE: Initialize SubscriberNode\n- messages_received = 0\n- received_values = []\n- last_value = 0.0
WASM_NODE --> BROWSER: Module loaded
deactivate WASM_NODE

BROWSER -> JS: Initialize ROSLIB.Ros
activate JS
JS -> RB: WebSocket connect\nws://localhost:9090
activate RB
RB --> JS: Connection established
RB --> JS: WebSocket ready
JS -> JS: Create ROSLIB.Topic\n/sensor/temperature
JS -> JS: Set callback function
JS --> BROWSER: ROS connected
deactivate JS
deactivate RB

== Message Subscription Loop ==
loop Continuous
    ROS -> RB: New message available\nfrom /sensor/temperature
    activate RB
    RB -> JS: WebSocket message\ncallback triggered
    activate JS
    JS -> JS: Parse ROS message\nExtract JSON data
    JS -> WASM_NODE: processMessage(JSON string)
    activate WASM_NODE
    
    WASM_NODE -> WASM_NODE: Parse JSON\nExtract value field
    WASM_NODE -> WASM_NODE: messages_received++\nreceived_values.push(value)
    WASM_NODE -> WASM_NODE: Keep last 10 values\nRemove oldest if > 10
    WASM_NODE -> WASM_NODE: Calculate average\nfrom received_values
    WASM_NODE -> WASM_NODE: Check alarm condition\nif value > 25 degrees C
    WASM_NODE --> JS: return statistics\n- messages_received\n- last_value\n- average_value
    deactivate WASM_NODE
    
    JS -> WASM_NODE: getMessagesReceived()
    activate WASM_NODE
    WASM_NODE --> JS: return count
    deactivate WASM_NODE
    
    JS -> WASM_NODE: getLastValue()
    activate WASM_NODE
    WASM_NODE --> JS: return value
    deactivate WASM_NODE
    
    JS -> WASM_NODE: getAverageValue()
    activate WASM_NODE
    WASM_NODE --> JS: return average
    deactivate WASM_NODE
    
    JS -> BROWSER: Update UI\n- Messages received\n- Last value\n- Average value\n- Alarm status
    deactivate JS
    deactivate RB
end

note over WASM_NODE
  **Inside Subscriber WASM:**
  
  • SubscriberNode class (C++)
  • processMessage() - message processing
  • getMessagesReceived() - statistics
  • getLastValue() - current reading
  • getAverageValue() - calculation
  • All compiled to WASM bytecode
  • Executed by WASM runtime
end note

note over JS, RB
  **Communication Layer:**
  
  • JavaScript: ROSLIB.js bridge
  • ROS Bridge: External ROS2 process
  • WebSocket: ws://localhost:9090
  • Topic: /sensor/temperature
  • Callback: Automatic on message
end note

@enduml

